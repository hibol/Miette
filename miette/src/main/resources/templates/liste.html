<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('Liste des recettes')}"></head>
<body class="container mt-5">
    <div th:replace="~{fragments/header :: site-header}"></div>
    <div th:replace="~{fragments/login-modal :: login-modal}"></div>
    
    <!-- Barre de recherche -->
    <div class="search-bar mb-4">
        <form method="GET" class="d-flex">
            <input type="search" name="q" 
            th:value="${query}" 
            th:placeholder="${isSearchMode} ? 'Recherche active...' : 'üç≥ Titre, ingr√©dients, √©tapes, tags...'"
            class="form-control form-control-lg me-2">
            <button type="submit" class="btn btn-primary btn-lg px-4">
                <i class="bi bi-search"></i>
            </button>
        </form>
    </div>

    <!-- Message de succ√®s (ex: suppression) -->
    <div th:if="${message}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle"></i> 
        <span th:text="${message}">Supprim√© !</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    
    <!-- R√©sultats ou "Tout" + bouton reset -->
    <div th:if="${isSearchMode}" class="alert alert-info d-flex justify-content-between align-items-center">
        <span><i class="bi bi-search"></i> 
            <span th:text="'Trouv√© ' + ${resultCount} + ' recette(s)'"></span>
        </span>
        <a href="/recettes" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-grid-3x3-gap"></i> Voir toutes les recettes
        </a>
    </div>
    <div th:unless="${isSearchMode}" class="alert alert-success">
        <i class="bi bi-list-ul"></i> Toutes les recettes (
        <span th:text="${resultCount}"></span>)
    </div>
    
    <div th:if="${recipes.isEmpty()}">
        <p class="alert alert-info">Aucune recette</p>
    </div>
    
    <div th:unless="${recipes.isEmpty()}" class="row g-4">
        <div th:each="recipe : ${recipes}" class="col-md-6 col-lg-4">
            <a th:href="@{/recette/{id}(id=${recipe.id})}" class="text-decoration-none recipe-link">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0" th:text="${recipe.title}">Recette</h5>
                        <div th:if="${!#lists.isEmpty(recipe.tags)}" class="mt-2">
                            <span th:each="tagRel : ${recipe.tags}" 
                            th:text="${tagRel.tag.label}" 
                            class="badge bg-secondary me-1"></span>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- UNE SEULE phase vide ‚Üí ingr√©dients/√©tapes directs -->
                        <div th:if="${#lists.size(recipe.phases) == 1 and recipe.phases[0].label == ''}">
                            <!-- Ingr√©dients -->
                            <h6><i class="bi bi-egg-fried"></i> Ingr√©dients</h6>
                            <ul class="list-unstyled small">
                                <li th:each="ingRel : ${recipe.phases[0].ingredientPhases}" 
                                th:text="${ingRel.ingredient.label} + ' : ' + 
                                (${ingRel.quantity} % 1 == 0 ? 
                                ${#numbers.formatDecimal(ingRel.quantity, 0, 0)} : 
                                ${#numbers.formatDecimal(ingRel.quantity, 0, 1)}) + 
                                ' ' + 
                                (${ingRel.ingredient.unit} == null ? '' : ${ingRel.ingredient.unit})">
                            </ul>
                            
                            <!-- √âtapes -->
                            <h6 class="mt-3"><i class="bi bi-list-numbered"></i> √âtapes</h6>
                            <ol class="small">
                                <li th:each="step : ${recipe.phases[0].steps}" 
                                th:text="${step.label}"></li>
                            </ol>
                        </div>
                        
                        <!-- MULTIPLES phases nomm√©es ‚Üí d√©tail par phase -->
                        <div th:unless="${#lists.size(recipe.phases) == 1 and recipe.phases[0].label == ''}">
                            <div th:each="phase : ${recipe.phases}" class="mb-4">
                                <h6 class="fw-bold text-primary" th:text="${phase.label}">Phase</h6>
                                
                                <!-- Ingr√©dients phase -->
                                <div th:if="${#lists.size(phase.ingredientPhases) > 0}">
                                    <small class="text-muted">Ingr√©dients :</small>
                                    <ul class="list-unstyled small mt-1">
                                        <li th:each="ingRel : ${phase.ingredientPhases}" 
                                        th:text="${ingRel.ingredient.label} + ' : ' + 
                                        (${ingRel.quantity} % 1 == 0 ? 
                                        ${#numbers.formatDecimal(ingRel.quantity, 0, 0)} : 
                                        ${#numbers.formatDecimal(ingRel.quantity, 0, 1)}) + 
                                        ' ' + 
                                        (${ingRel.ingredient.unit} == null ? '' : ${ingRel.ingredient.unit})">
                                    </ul>
                                </div>
                                
                                <!-- √âtapes phase -->
                                <div th:if="${#lists.size(phase.steps) > 0}" class="mt-2">
                                    <ol class="small mb-0">
                                        <li th:each="step : ${phase.steps}" 
                                        th:text="${step.label}"></li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    </div>
    <div th:replace="~{fragments/layout :: scripts}"></div>
</body>
</html>
